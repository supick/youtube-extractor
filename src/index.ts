import { Hono } from "hono";
import { cors } from "hono/cors";
import { z } from "zod";

const app = new Hono();
let template = "PCFET0NUWVBFIGh0bWw+CjxodG1sIGxhbmc9ImVuIiBkYXRhLXRoZW1lPSJkYXJrIiBwcmVmZXJzLWNvbG9yLXNjaGVtZT0iZGFyayI+Cgo8aGVhZD4KICA8bWV0YSBjaGFyc2V0PSJ1dGYtOCIgLz4KICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEiIC8+CiAgPHRpdGxlPllvdXR1YmUgRXh0cmFjdG9yPC90aXRsZT4KICA8bWV0YSBuYW1lPSJkZXNjcmlwdGlvbiIgY29udGVudD0iWW91dHViZSBFeHRyYWN0b3IiIC8+CiAgPGxpbmsgcmVsPSJzaG9ydGN1dCBpY29uIiBocmVmPSJodHRwczovL3BpY29jc3MuY29tL2Zhdmljb24uaWNvIiAvPgogIDxsaW5rIHJlbD0ic3R5bGVzaGVldCIgaHJlZj0iaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L25wbS9AcGljb2Nzcy9waWNvQDEvY3NzL3BpY28ubWluLmNzcyIgLz4KICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Imh0dHBzOi8vY2RuanMuY2xvdWRmbGFyZS5jb20vYWpheC9saWJzL2ZvbnQtYXdlc29tZS82LjQuMC9jc3MvYWxsLm1pbi5jc3MiIC8+CgogIDxzdHlsZT4KICAgIGJvZHk+bWFpbiB7CiAgICAgIC8qIGRpc3BsYXk6IGZsZXg7CiAgICAgICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsgKi8KICAgICAgbWluLWhlaWdodDogY2FsYygxMDB2aCAtIDdyZW0pOwogICAgICBwYWRkaW5nOiAxcmVtIDA7CiAgICB9CgogICAgYm9keT5uYXYgewogICAgICBiYWNrZ3JvdW5kLWNvbG9yOiB2YXIoLS1jYXJkLWJhY2tncm91bmQtY29sb3IpOwogICAgICBib3gtc2hhZG93OiB2YXIoLS1jYXJkLWJveC1zaGFkb3cpOwogICAgfQoKICAgIGJvZHk+Zm9vdGVyIHsKICAgICAgcGFkZGluZzogMXJlbSAwOwogICAgfQogIDwvc3R5bGU+CjwvaGVhZD4KCjxib2R5PgogIDwhLS0gTmF2IC0tPgogIDxuYXYgY2xhc3M9ImNvbnRhaW5lci1mbHVpZCI+CiAgICA8dWw+CiAgICAgIDxsaT4KICAgICAgICA8YSBocmVmPSIvIiBjbGFzcz0iY29udHJhc3QiPjxzdHJvbmc+WW91dHViZSBFeHRyYWN0b3I8L3N0cm9uZz48L2E+CiAgICAgIDwvbGk+CiAgICA8L3VsPgogICAgPHVsPgogICAgICA8bGk+CiAgICAgICAgPGkgY2xhc3M9ImZhLXNvbGlkIGZhLW1hZ25pZnlpbmctZ2xhc3MiIGRhdGEtdGFyZ2V0PSJtb2RhbC1zZWFyY2giIG9uY2xpY2s9InRvZ2dsZU1vZGFsKGV2ZW50KSI+PC9pPgogICAgICA8L2xpPgogICAgICA8bGk+CiAgICAgICAgPGRldGFpbHMgcm9sZT0ibGlzdCIgZGlyPSJydGwiPgogICAgICAgICAgPHN1bW1hcnkgYXJpYS1oYXNwb3B1cD0ibGlzdGJveCIgcm9sZT0ibGluayIgY2xhc3M9InNlY29uZGFyeSI+PC9zdW1tYXJ5PgogICAgICAgICAgPHVsIHJvbGU9Imxpc3Rib3giPgogICAgICAgICAgICA8bGk+PGEgaHJlZj0iIyIgZGF0YS10aGVtZS1zd2l0Y2hlcj0iYXV0byI+QXV0bzwvYT48L2xpPgogICAgICAgICAgICA8bGk+PGEgaHJlZj0iIyIgZGF0YS10aGVtZS1zd2l0Y2hlcj0ibGlnaHQiPkxpZ2h0PC9hPjwvbGk+CiAgICAgICAgICAgIDxsaT48YSBocmVmPSIjIiBkYXRhLXRoZW1lLXN3aXRjaGVyPSJkYXJrIj5EYXJrPC9hPjwvbGk+CiAgICAgICAgICA8L3VsPgogICAgICAgIDwvZGV0YWlscz4KICAgICAgPC9saT4KICAgIDwvdWw+CiAgPC9uYXY+CiAgPCEtLSAuLyBOYXYgLS0+CgogIDwhLS0gTWFpbiAtLT4KICA8bWFpbiBjbGFzcz0iY29udGFpbmVyLWZsdWlkIj4KICAgIDxkaXYgY2xhc3M9ImNvbnRhaW5lciI+CiAgICAgIDxoMT5Zb3V0dWJlIEV4dHJhY3RvcjwvaDE+CiAgICAgIDxmb3JtPgogICAgICAgIDxkaXYgY2xhc3M9ImdyaWQiPgogICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGlkPSJ5b3V0dWJlX3NlYXJjaCIgbmFtZT0iaWQiIHBsYWNlaG9sZGVyPSJZb3V0dWJlIElEIiByZXF1aXJlZD4KICAgICAgICAgIDxidXR0b24gdHlwZT0ic3VibWl0Ij5TdWJtaXQ8L2J1dHRvbj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9mb3JtPgogICAgPC9kaXY+CiAgPC9tYWluPgogIDwhLS0gLi8gTWFpbiAtLT4KCiAgPCEtLSBNb2RhbCBTZWFyY2ggLS0+CiAgPGRpYWxvZyBpZD0ibW9kYWwtc2VhcmNoIj4KICAgIDxhcnRpY2xlIGNsYXNzPSJkZW1vIj4KICAgICAgPGEgaHJlZj0iI2Nsb3NlIiBhcmlhLWxhYmVsPSJDbG9zZSIgY2xhc3M9ImNsb3NlIiBkYXRhLXRhcmdldD0ibW9kYWwtc2VhcmNoIiBvbmNsaWNrPSJ0b2dnbGVNb2RhbChldmVudCkiPjwvYT4KICAgICAgPGZvcm0+CiAgICAgICAgPGxhYmVsIGZvcj0ic2VhcmNoIj5TZWFyY2g8L2xhYmVsPgogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBpZD0iaWQiIG5hbWU9ImlkIiBwbGFjZWhvbGRlcj0iIiByZXF1aXJlZD4KICAgICAgICA8YnV0dG9uIHR5cGU9InN1Ym1pdCI+PGkgY2xhc3M9ImZhLXNvbGlkIGZhLW1hZ25pZnlpbmctZ2xhc3MiPjwvaT4gU2VhcmNoPC9idXR0b24+CiAgICAgIDwvZm9ybT4KICAgIDwvYXJ0aWNsZT4KICA8L2RpYWxvZz4KICA8IS0tIC4vIE1vZGFsIFNlYXJjaCAtLT4KCiAgPCEtLSBGb290ZXIgLS0+CiAgPGZvb3RlciBjbGFzcz0iY29udGFpbmVyLWZsdWlkIj4KICAgIDxzbWFsbD5Db3B5cmlnaHQgPGEgaHJlZj0iLyIgY2xhc3M9InNlY29uZGFyeSI+MjAyMzwvYT4gLQogICAgICA8YSBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vYWp6YmMveW91dHViZS1leHRyYWN0b3IiIGNsYXNzPSJzZWNvbmRhcnkiPllvdXR1YmUgRXh0cmFjdG9yPC9hPgogICAgPC9zbWFsbD4KICA8L2Zvb3Rlcj4KICA8IS0tIC4vIEZvb3RlciAtLT4KCiAgPCEtLSBNaW5pbWFsIHRoZW1lIHN3aXRjaGVyIC0tPgogIDxzY3JpcHQ+Y29uc3QgdGhlbWVTd2l0Y2hlciA9IHsgX3NjaGVtZTogImRhcmsiLCBtZW51VGFyZ2V0OiAiZGV0YWlsc1tyb2xlPSdsaXN0J10iLCBidXR0b25zVGFyZ2V0OiAiYVtkYXRhLXRoZW1lLXN3aXRjaGVyXSIsIGJ1dHRvbkF0dHJpYnV0ZTogImRhdGEtdGhlbWUtc3dpdGNoZXIiLCByb290QXR0cmlidXRlOiAiZGF0YS10aGVtZSIsIGxvY2FsU3RvcmFnZUtleTogInBpY29QcmVmZXJyZWRDb2xvclNjaGVtZSIsIGluaXQoKSB7IHRoaXMuc2NoZW1lID0gdGhpcy5zY2hlbWVGcm9tTG9jYWxTdG9yYWdlLCB0aGlzLmluaXRTd2l0Y2hlcnMoKSB9LCBnZXQgc2NoZW1lRnJvbUxvY2FsU3RvcmFnZSgpIHsgcmV0dXJuIHZvaWQgMCAhPT0gd2luZG93LmxvY2FsU3RvcmFnZSAmJiBudWxsICE9PSB3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5sb2NhbFN0b3JhZ2VLZXkpID8gd2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKHRoaXMubG9jYWxTdG9yYWdlS2V5KSA6IHRoaXMuX3NjaGVtZSB9LCBnZXQgcHJlZmVycmVkQ29sb3JTY2hlbWUoKSB7IHJldHVybiB3aW5kb3cubWF0Y2hNZWRpYSgiKHByZWZlcnMtY29sb3Itc2NoZW1lOiBkYXJrKSIpLm1hdGNoZXMgPyAiZGFyayIgOiAibGlnaHQiIH0sIGluaXRTd2l0Y2hlcnMoKSB7IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwodGhpcy5idXR0b25zVGFyZ2V0KS5mb3JFYWNoKChlID0+IHsgZS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICh0ID0+IHsgdC5wcmV2ZW50RGVmYXVsdCgpLCB0aGlzLnNjaGVtZSA9IGUuZ2V0QXR0cmlidXRlKHRoaXMuYnV0dG9uQXR0cmlidXRlKSwgZG9jdW1lbnQucXVlcnlTZWxlY3Rvcih0aGlzLm1lbnVUYXJnZXQpLnJlbW92ZUF0dHJpYnV0ZSgib3BlbiIpIH0pLCAhMSkgfSkpIH0sIHNldCBzY2hlbWUoZSkgeyAiYXV0byIgPT0gZSA/ICJkYXJrIiA9PSB0aGlzLnByZWZlcnJlZENvbG9yU2NoZW1lID8gdGhpcy5fc2NoZW1lID0gImRhcmsiIDogdGhpcy5fc2NoZW1lID0gImxpZ2h0IiA6ICJkYXJrIiAhPSBlICYmICJsaWdodCIgIT0gZSB8fCAodGhpcy5fc2NoZW1lID0gZSksIHRoaXMuYXBwbHlTY2hlbWUoKSwgdGhpcy5zY2hlbWVUb0xvY2FsU3RvcmFnZSgpIH0sIGdldCBzY2hlbWUoKSB7IHJldHVybiB0aGlzLl9zY2hlbWUgfSwgYXBwbHlTY2hlbWUoKSB7IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoImh0bWwiKS5zZXRBdHRyaWJ1dGUodGhpcy5yb290QXR0cmlidXRlLCB0aGlzLnNjaGVtZSkgfSwgc2NoZW1lVG9Mb2NhbFN0b3JhZ2UoKSB7IHZvaWQgMCAhPT0gd2luZG93LmxvY2FsU3RvcmFnZSAmJiB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0odGhpcy5sb2NhbFN0b3JhZ2VLZXksIHRoaXMuc2NoZW1lKSB9IH07IHRoZW1lU3dpdGNoZXIuaW5pdCgpOzwvc2NyaXB0PgogIDxzY3JpcHQ+Y29uc3QgaXNPcGVuQ2xhc3MgPSAibW9kYWwtaXMtb3BlbiIsIG9wZW5pbmdDbGFzcyA9ICJtb2RhbC1pcy1vcGVuaW5nIiwgY2xvc2luZ0NsYXNzID0gIm1vZGFsLWlzLWNsb3NpbmciLCBhbmltYXRpb25EdXJhdGlvbiA9IDQwMDsgbGV0IHZpc2libGVNb2RhbCA9IG51bGw7IGNvbnN0IHRvZ2dsZU1vZGFsID0gZSA9PiB7IGUucHJldmVudERlZmF1bHQoKTsgY29uc3QgdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGUuY3VycmVudFRhcmdldC5nZXRBdHRyaWJ1dGUoImRhdGEtdGFyZ2V0IikpOyB2b2lkIDAgIT09IHQgJiYgbnVsbCAhPSB0ICYmIGlzTW9kYWxPcGVuKHQpID8gY2xvc2VNb2RhbCh0KSA6IG9wZW5Nb2RhbCh0KSB9LCBpc01vZGFsT3BlbiA9IGUgPT4gISghZS5oYXNBdHRyaWJ1dGUoIm9wZW4iKSB8fCAiZmFsc2UiID09IGUuZ2V0QXR0cmlidXRlKCJvcGVuIikpLCBvcGVuTW9kYWwgPSBlID0+IHsgaXNTY3JvbGxiYXJWaXNpYmxlKCkgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlLnNldFByb3BlcnR5KCItLXNjcm9sbGJhci13aWR0aCIsIGAke2dldFNjcm9sbGJhcldpZHRoKCl9cHhgKSwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsYXNzTGlzdC5hZGQoaXNPcGVuQ2xhc3MsIG9wZW5pbmdDbGFzcyksIHNldFRpbWVvdXQoKCgpID0+IHsgdmlzaWJsZU1vZGFsID0gZSwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUob3BlbmluZ0NsYXNzKSB9KSwgNDAwKSwgZS5zZXRBdHRyaWJ1dGUoIm9wZW4iLCAhMCkgfSwgY2xvc2VNb2RhbCA9IGUgPT4geyB2aXNpYmxlTW9kYWwgPSBudWxsLCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xhc3NMaXN0LmFkZChjbG9zaW5nQ2xhc3MpLCBzZXRUaW1lb3V0KCgoKSA9PiB7IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGFzc0xpc3QucmVtb3ZlKGNsb3NpbmdDbGFzcywgaXNPcGVuQ2xhc3MpLCBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuc3R5bGUucmVtb3ZlUHJvcGVydHkoIi0tc2Nyb2xsYmFyLXdpZHRoIiksIGUucmVtb3ZlQXR0cmlidXRlKCJvcGVuIikgfSksIDQwMCkgfTsgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoZSA9PiB7IGlmIChudWxsICE9IHZpc2libGVNb2RhbCkgeyAhdmlzaWJsZU1vZGFsLnF1ZXJ5U2VsZWN0b3IoImFydGljbGUiKS5jb250YWlucyhlLnRhcmdldCkgJiYgY2xvc2VNb2RhbCh2aXNpYmxlTW9kYWwpIH0gfSkpLCBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCJrZXlkb3duIiwgKGUgPT4geyAiRXNjYXBlIiA9PT0gZS5rZXkgJiYgbnVsbCAhPSB2aXNpYmxlTW9kYWwgJiYgY2xvc2VNb2RhbCh2aXNpYmxlTW9kYWwpIH0pKTsgY29uc3QgZ2V0U2Nyb2xsYmFyV2lkdGggPSAoKSA9PiB7IGNvbnN0IGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsgZS5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiIsIGUuc3R5bGUub3ZlcmZsb3cgPSAic2Nyb2xsIiwgZS5zdHlsZS5tc092ZXJmbG93U3R5bGUgPSAic2Nyb2xsYmFyIiwgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChlKTsgY29uc3QgdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImRpdiIpOyBlLmFwcGVuZENoaWxkKHQpOyBjb25zdCBsID0gZS5vZmZzZXRXaWR0aCAtIHQub2Zmc2V0V2lkdGg7IHJldHVybiBlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoZSksIGwgfSwgaXNTY3JvbGxiYXJWaXNpYmxlID0gKCkgPT4gZG9jdW1lbnQuYm9keS5zY3JvbGxIZWlnaHQgPiBzY3JlZW4uaGVpZ2h0Ozwvc2NyaXB0Pgo8L2JvZHk+Cgo8L2h0bWw+";
template = atob(template);
app.use("/", cors());

app.all("/", async (c) => {
	const { id } = c.req.query();

	if (!id) {
		return c.html(template);
	}

	const videoID = z.string().parse(id);
	const youtubeVideoURL = `https://www.youtube.com/watch?v=${videoID}`;

	const response = await fetch(youtubeVideoURL);
	const html = await response.text();

	// find video data object:  ytInitialPlayerResponse = {...};
	const regex = html.match(`var ytInitialPlayerResponse = (.*);<\/script>`);
	if (!regex) throw new Error("Unable to find video data");

	const json = JSON.parse(regex[1]);

	return c.text(JSON.stringify(json, null, 2));
});

app.onError((err, c) => {
	console.error(`${err}`);
	return c.text(err.toString(), 500);
});

export default app;
